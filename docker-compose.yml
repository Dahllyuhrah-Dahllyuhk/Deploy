services:
  # ── Redis (RefreshToken, InviteCode 캐시, 블랙리스트) ─────────────────
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - appnet
    command: >
      redis-server
      --requirepass "${REDIS_PASSWORD}"
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── MongoDB (Meeting, CalendarEvent, GoogleOAuthClient) ───────────────
  mongo:
    image: mongo:7
    container_name: mongo
    restart: unless-stopped
    networks:
      - appnet
    volumes:
      - mongo_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: matuabom
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # ── Backend (Spring Boot) ────────────────────────────────────────────
  be:
    env_file: .env
    image: 774023531956.dkr.ecr.ap-northeast-2.amazonaws.com/matuabom-be:latest
    container_name: be
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
    networks:
      - appnet
    environment:
      # MongoDB (Docker)
      SPRING_DATA_MONGODB_URI: "mongodb://mongo:27017/matuabom"
      # PostgreSQL → AWS RDS (외부 호스트)
      POSTGRES_URL:            "${POSTGRES_URL}"
      POSTGRES_USER:           "${POSTGRES_USER}"
      POSTGRES_PASSWORD:       "${POSTGRES_PASSWORD}"
      # Redis (Docker)
      REDIS_HOST:              "redis"
      REDIS_PORT:              "6379"
      REDIS_PASSWORD:          "${REDIS_PASSWORD}"
      # Auth
      JWT_SECRET:              "${JWT_SECRET}"
      KAKAO_CLIENT_ID:         "${KAKAO_CLIENT_ID}"
      KAKAO_CLIENT_SECRET:     "${KAKAO_CLIENT_SECRET}"
      GOOGLE_CLIENT_ID:        "${GOOGLE_CLIENT_ID}"
      GOOGLE_CLIENT_SECRET:    "${GOOGLE_CLIENT_SECRET}"
      GEMINI_API_KEY:          "${GEMINI_API_KEY}"
      FRONTEND_ORIGIN:         "https://matuabom.store"
      BACKEND_BASE_URL:        "https://matuabom.store"
      COOKIE_SECURE:           "true"
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ── Frontend (Next.js) ───────────────────────────────────────────────
  fe:
    image: 774023531956.dkr.ecr.ap-northeast-2.amazonaws.com/matuabom-fe:latest
    container_name: fe
    restart: unless-stopped
    depends_on:
      be:
        condition: service_healthy
    networks:
      - appnet
    environment:
      NEXT_PUBLIC_API_BASE: "https://matuabom.store"
      NODE_ENV:             "production"
    ports:
      - "3000:3000"

  # ── AI 서비스 ─────────────────────────────────────────────────────────
  ai:
    env_file: .env
    image: 774023531956.dkr.ecr.ap-northeast-2.amazonaws.com/matuabom-ai:latest
    container_name: ai
    restart: unless-stopped
    depends_on:
      be:
        condition: service_healthy
    networks:
      - appnet
    environment:
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
    ports:
      - "5000:5000"

  # ── Nginx (Reverse Proxy) ────────────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: nginx
    restart: unless-stopped
    depends_on:
      - fe
      - be
      - ai
    networks:
      - appnet
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro

volumes:
  redis_data:
  mongo_data:

networks:
  appnet:
    driver: bridge
